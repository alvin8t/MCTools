{"version":3,"file":"differentialUpdateInfoBuilder.js","sourceRoot":"","sources":["../../src/targets/differentialUpdateInfoBuilder.ts"],"names":[],"mappings":";;;;;;;;;;;;;;oEA4DO,AAAK,WAAyB,AAAY;AAC/C,AAAM,eAAC,AAAI,KAAC,AAAK,OAAC,MAAM,AAAI,mCAAC,MAAM,AAAe,AAAE,oBAAE,CAAC,AAAK,OAAE,AAAI,MAAE,AAAc,gBAAE,AAAS,AAAC,AAAC,AAAC,AAClG;AAAC,AAED,AAAM;;;;;;;;qEAAC,AAAK,WAAyB,AAAY,MAAE,AAAc,QAAE,AAA+B,UAAE,AAA+B;AACjI,cAAM,AAAY,AAAG,kBAAG,AAAI,OAAG,AAAqB,qBAAE;AACtD,cAAM,AAAU,aAAuB,AAAI,KAAC,AAAK,OAAC,MAAM,AAAI,mCAAC,MAAM,AAAe,AAAE,oBAAE,CAAC,AAAK,OAAE,AAAI,MAAE,AAAM,QAAE,AAAY,AAAC,AAAC,AAAC;AAC3H,AAAQ,iBAAC,AAAI,KAAC,AAAuB;AACnC,AAAI,kBAAE,AAAY;AAClB,AAAgB,AAAE,iCAAG,AAAgB,mBAAG,AAAqB,qBAAE;AAC/D,AAAM;AACN,AAAI,kBAAE,AAAI;AACV,AAAQ;AACR,AAAU,AACX,AAAC;AAPoC;AAQtC,AAAM,eAAC,AAAU,AACnB;AAAC;;;;;;;;;;;;;;AA3ED,AAAO,AAAE,AAAI,AAAE,AAAM,AAAuB;;;;AAC5C,AAAO,AAAK,AAAI,AAAM,AAAM;;;;AAI5B,AAAO,AAAE,AAAO,AAAE,AAAM,AAAS,AAEjC,AAAM;;;;;;AAAC,MAAM,AAAqB,wDAAG,AAAW,AAEhD,AAAM;6CAA8C,AAAoB,cAAE,AAAiD;AACzH,AAAE,AAAC,QAAC,AAAY,gBAAI,AAAI,AAAC,MAAC,AAAC;AACzB,AAAM,eAAC,AAAI,AACb;AAAC;AAED,UAAM,AAAI,OAAG,AAAM,OAAC,AAAI,KAAC,AAAY,AAAC;AACtC,AAAE,AAAC,QAAC,AAAI,KAAC,AAAM,UAAI,AAAC,AAAC,GAAC,AAAC;AACrB,AAAM,eAAC,AAAI,AACb;AAAC;AAED,UAAM,AAAQ,WAAwC,AAAE;AACxD,AAAG,AAAC,SAAC,MAAM,AAAI,QAAI,AAAI,AAAC,MAAC,AAAC;AACxB,cAAM,AAAe,kBAAG,AAAY,aAAC,AAAI,AAAC;AAC1C,AAAQ,iBAAC,AAAI,AAAC,0BACT,AAAe,mBAClB,AAAI,MAAE,AAAI,MAAC,AAAQ,SAAC,AAAe,gBAAC,AAAI,AAAC,AAC1C,AACH;AAAC;AACD,AAAM,WAAC,EAAC,AAAQ,AAAC,AACnB;AAAC,AAED,AAAM;kDAAmD,AAA8B;AACrF,AAOG;;;;;;;AACH,AAAc,mBAAC,AAAQ,WAAG,AAAC;AAC3B,AAAuE;AACvE,AAAc,mBAAC,AAAW,cAAG,AAAQ;AACrC,AAAM,WAAC,AAAc,AACvB;AAAC;AAED;AACE,AAAuC;AACvC,AAAM;AACJ,AAAU,oBAAE,AAA2B;AACvC,AAAI,cAAE,AAAmB;AACzB,AAAO,iBAAE,AAAO;AAChB,AAAG,aAAE,AAA0F;AAC/F,AAAY,sBAAE,AAA0F;AACxG,AAAW,qBAAE,AAA0F;AACvG,AAAU,oBAAE,AAA0F;AACtG,AAAS,mBAAE,AAA0F,AACtG,AAAC,AACJ;AAViB,KAAR,AAAO;AAUf,AAED,AAAM","sourcesContent":["import { BlockMapDataHolder, PackageFileInfo } from \"builder-util-runtime\"\nimport { exec } from \"builder-util/out/util\"\nimport * as path from \"path\"\nimport { Target } from \"../core\"\nimport { PlatformPackager } from \"../platformPackager\"\nimport { ArchiveOptions } from \"./archive\"\nimport { getTool } from \"./tools\"\n\nexport const BLOCK_MAP_FILE_SUFFIX = \".blockmap\"\n\nexport function createNsisWebDifferentialUpdateInfo(artifactPath: string, packageFiles: { [arch: string]: PackageFileInfo }) {\n  if (packageFiles == null) {\n    return null\n  }\n\n  const keys = Object.keys(packageFiles)\n  if (keys.length <= 0) {\n    return null\n  }\n\n  const packages: { [arch: string]: PackageFileInfo } = {}\n  for (const arch of keys) {\n    const packageFileInfo = packageFiles[arch]\n    packages[arch] = {\n      ...packageFileInfo,\n      path: path.basename(packageFileInfo.path)\n    }\n  }\n  return {packages}\n}\n\nexport function configureDifferentialAwareArchiveOptions(archiveOptions: ArchiveOptions): ArchiveOptions {\n  /*\n   * dict size 64 MB: Full: 33,744.88 KB, To download: 17,630.3 KB (52%)\n   * dict size 16 MB: Full: 33,936.84 KB, To download: 16,175.9 KB (48%)\n   * dict size  8 MB: Full: 34,187.59 KB, To download:  8,229.9 KB (24%)\n   * dict size  4 MB: Full: 34,628.73 KB, To download: 3,782.97 KB (11%)\n\n   as we can see, if file changed in one place, all block is invalidated (and update size approximately equals to dict size)\n   */\n  archiveOptions.dictSize = 4\n  // do not allow to change compression level to avoid different packages\n  archiveOptions.compression = \"normal\"\n  return archiveOptions\n}\n\nfunction getBlockMapTool() {\n  // noinspection SpellCheckingInspection\n  return getTool({\n    repository: \"develar/block-map-builder\",\n    name: \"block-map-builder\",\n    version: \"0.2.0\",\n    mac: \"J+aspHER9Hba70oDJAg9ZUyr5KC8beTjIedMQRgrdsWd5Qlc+0COy+zXMw7Pcq+hqDvsEFoM2N4Yx6wQAaXDXA==\",\n    \"linux-ia32\": \"2zkhj4GVvLg8JDsGIDc4CUeZ+eHxwPchNuub+FTjO98YJyCIKDItJorfTStoZe4qlYqCE1tAX7Q/NXmBvpwj6A==\",\n    \"linux-x64\": \"2iErpiWfSMWMMFALd2sIcfU7cd4mFc96EzA/6j9/XCAx0Z6y6vSJinwjMlcemN2SUUsyVkUnHkinCLK7M34GXQ==\",\n    \"win-ia32\": \"QH/b+cmbsPtyaGzKriNGQtvKQ0KEUictieprGgcP7s4flHDXcsO+WtkecZpuJn5m3VLR0dGeSOw/oDxGxszBZA==\",\n    \"win-x64\": \"GMT7M9IibT8v5OY45N7Ar97rHpBcc9HexUGGePnzkv++4Dh7DjIlEeo/Q50MRRkp6pdgIrkG1OawEbJIt2DkLw==\",\n  })\n}\n\nexport async function appendBlockmap(file: string): Promise<BlockMapDataHolder> {\n  return JSON.parse(await exec(await getBlockMapTool(), [\"-in\", file, \"-compression\", \"deflate\"]))\n}\n\nexport async function createBlockmap(file: string, target: Target, packager: PlatformPackager<any>, safeArtifactName: string | null): Promise<BlockMapDataHolder> {\n  const blockMapFile = `${file}${BLOCK_MAP_FILE_SUFFIX}`\n  const updateInfo: BlockMapDataHolder = JSON.parse(await exec(await getBlockMapTool(), [\"-in\", file, \"-out\", blockMapFile]))\n  packager.info.dispatchArtifactCreated({\n    file: blockMapFile,\n    safeArtifactName: `${safeArtifactName}${BLOCK_MAP_FILE_SUFFIX}`,\n    target,\n    arch: null,\n    packager,\n    updateInfo,\n  })\n  return updateInfo\n}"]}
