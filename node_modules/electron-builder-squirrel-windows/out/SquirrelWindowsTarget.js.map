{"version":3,"file":"SquirrelWindowsTarget.js","sourceRoot":"","sources":["../src/SquirrelWindowsTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import { log } from \"builder-util\"\nimport { getBinFromGithub } from \"builder-util/out/binDownload\"\nimport { Arch, getArchSuffix, SquirrelWindowsOptions, Target } from \"electron-builder-lib\"\nimport { WinPackager } from \"electron-builder-lib/out/winPackager\"\nimport * as path from \"path\"\nimport sanitizeFileName from \"sanitize-filename\"\nimport { convertVersion, SquirrelBuilder, SquirrelOptions } from \"./squirrelPack\"\n\nexport default class SquirrelWindowsTarget extends Target {\n  //tslint:disable-next-line:no-object-literal-type-assertion\n  readonly options: SquirrelWindowsOptions = {...this.packager.platformSpecificBuildOptions, ...this.packager.config.squirrelWindows} as SquirrelWindowsOptions\n\n  constructor(private readonly packager: WinPackager, readonly outDir: string) {\n    super(\"squirrel\")\n  }\n\n  async build(appOutDir: string, arch: Arch) {\n    const packager = this.packager\n    const version = packager.appInfo.version\n    const sanitizedName = sanitizeFileName(this.appName)\n\n    // tslint:disable-next-line:no-invalid-template-strings\n    const setupFile = packager.expandArtifactNamePattern(this.options, \"exe\", arch, \"${productName} Setup ${version}.${ext}\")\n    const packageFile = `${sanitizedName}-${convertVersion(version)}-full.nupkg`\n\n    const installerOutDir = path.join(this.outDir, `squirrel-windows${getArchSuffix(arch)}`)\n\n    const artifactPath = path.join(installerOutDir, setupFile)\n\n    this.logBuilding(\"Squirrel.Windows\", artifactPath, arch)\n    if (arch === Arch.ia32) {\n      log.warn(\"For windows consider only distributing 64-bit or use nsis target, see https://github.com/electron-userland/electron-builder/issues/359#issuecomment-214851130\")\n    }\n\n    const distOptions = await this.computeEffectiveDistOptions()\n    const squirrelBuilder = new SquirrelBuilder(distOptions as SquirrelOptions, installerOutDir, packager)\n    await squirrelBuilder.buildInstaller({setupFile, packageFile}, appOutDir, this.outDir, arch)\n\n    packager.dispatchArtifactCreated(artifactPath, this, arch, `${sanitizedName}-Setup-${version}${getArchSuffix(arch)}.exe`)\n\n    const packagePrefix = `${this.appName}-${convertVersion(version)}-`\n    packager.dispatchArtifactCreated(path.join(installerOutDir, `${packagePrefix}full.nupkg`), this, arch)\n    if (distOptions.remoteReleases != null) {\n      packager.dispatchArtifactCreated(path.join(installerOutDir, `${packagePrefix}delta.nupkg`), this, arch)\n    }\n\n    packager.dispatchArtifactCreated(path.join(installerOutDir, \"RELEASES\"), this, arch)\n  }\n\n  private get appName() {\n    return this.options.name || this.packager.appInfo.name\n  }\n\n  async computeEffectiveDistOptions(): Promise<SquirrelOptions> {\n    const packager = this.packager\n    let iconUrl = this.options.iconUrl\n    if (iconUrl == null) {\n      const info = await packager.info.repositoryInfo\n      if (info != null) {\n        iconUrl = `https://github.com/${info.user}/${info.project}/blob/master/${packager.info.relativeBuildResourcesDirname}/icon.ico?raw=true`\n      }\n\n      if (iconUrl == null) {\n        throw new Error(\"iconUrl is not specified, please see https://electron.build/configuration/configuration#WinBuildOptions-iconUrl\")\n      }\n    }\n\n    checkConflictingOptions(this.options)\n\n    const appInfo = packager.appInfo\n    const projectUrl = await appInfo.computePackageUrl()\n    const appName = this.appName\n    const options: SquirrelOptions = {\n      name: appName,\n      productName: this.options.name || appInfo.productName,\n      appId: this.options.useAppIdAsId ? appInfo.id : appName,\n      version: appInfo.version,\n      description: appInfo.description,\n      // better to explicitly set to empty string, to avoid any nugget errors\n      authors: appInfo.companyName || \"\",\n      iconUrl,\n      extraMetadataSpecs: projectUrl == null ? null : `\\n    <projectUrl>${projectUrl}</projectUrl>`,\n      copyright: appInfo.copyright,\n      packageCompressionLevel: parseInt((process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL || packager.compression === \"store\" ? 0 : 9) as any, 10),\n      vendorPath: await getBinFromGithub(\"Squirrel.Windows\", \"1.7.8\", \"p4Z7//ol4qih1xIl2l9lOeFf1RmX4y1eAJkol+3q7iZ0iEMotBhs3HXFLxU435xLRhKghYOjSYu7WiUktsP5Bg==\"),\n      ...this.options as any,\n    }\n\n    if (options.remoteToken == null) {\n      options.remoteToken = process.env.GH_TOKEN\n    }\n\n    if (!(\"loadingGif\" in options)) {\n      const resourceList = await packager.resourceList\n      if (resourceList.includes(\"install-spinner.gif\")) {\n        options.loadingGif = path.join(packager.buildResourcesDir, \"install-spinner.gif\")\n      }\n    }\n\n    if (this.options.remoteReleases === true) {\n      const info = await packager.info.repositoryInfo\n      if (info == null) {\n        log.warn(\"remoteReleases set to true, but cannot get repository info\")\n      }\n      else {\n        options.remoteReleases = `https://github.com/${info.user}/${info.project}`\n        log.info({remoteReleases: options.remoteReleases}, `remoteReleases is set`)\n      }\n    }\n\n    return options\n  }\n}\n\nfunction checkConflictingOptions(options: any) {\n  for (const name of [\"outputDirectory\", \"appDirectory\", \"exe\", \"fixUpPaths\", \"usePackageJson\", \"extraFileSpecs\", \"extraMetadataSpecs\", \"skipUpdateIcon\", \"setupExe\"]) {\n    if (name in options) {\n      throw new Error(`Option ${name} is ignored, do not specify it.`)\n    }\n  }\n\n  if (\"noMsi\" in options) {\n    log.warn(`noMsi is deprecated, please specify as \"msi\": true if you want to create an MSI installer`)\n    options.msi = !options.noMsi\n  }\n\n  const msi = options.msi\n  if (msi != null && typeof msi !== \"boolean\") {\n    throw new Error(`msi expected to be boolean value, but string '\"${msi}\"' was specified`)\n  }\n}\n"]}
