{"version":3,"file":"DifferentialDownloader.js","sourceRoot":"","sources":["../../src/differentialDownloader/DifferentialDownloader.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { BlockMapDataHolder, configureRequestOptionsFromUrl, createHttpError, DigestTransform, HttpExecutor } from \"builder-util-runtime\"\nimport { BlockMap } from \"builder-util-runtime/out/blockMapApi\"\nimport { close, closeSync, createWriteStream, open } from \"fs-extra-p\"\nimport { OutgoingHttpHeaders, RequestOptions } from \"http\"\nimport { Logger } from \"../main\"\nimport { copyData } from \"./DataSplitter\"\nimport { computeOperations, Operation, OperationKind } from \"./downloadPlanBuilder\"\nimport { checkIsRangesSupported, executeTasks } from \"./multipleRangeDownloader\"\n\nconst inflateRaw: any = BluebirdPromise.promisify(require(\"zlib\").inflateRaw)\n\nexport class DifferentialDownloaderOptions {\n  readonly oldFile: string\n  readonly newUrl: string\n  readonly logger: Logger\n  readonly newFile: string\n\n  readonly requestHeaders: OutgoingHttpHeaders | null\n\n  readonly useMultipleRangeRequest?: boolean\n}\n\nexport abstract class DifferentialDownloader {\n  private readonly baseRequestOptions: RequestOptions\n\n  fileMetadataBuffer: Buffer | null\n\n  private readonly logger: Logger\n\n  // noinspection TypeScriptAbstractClassConstructorCanBeMadeProtected\n  constructor(protected readonly blockAwareFileInfo: BlockMapDataHolder, readonly httpExecutor: HttpExecutor<any>, readonly options: DifferentialDownloaderOptions) {\n    this.logger = options.logger\n    this.baseRequestOptions = configureRequestOptionsFromUrl(options.newUrl, {})\n  }\n\n  protected get signatureSize(): number {\n    return 0\n  }\n\n  createRequestOptions(method: \"head\" | \"get\" = \"get\", newUrl?: string | null): RequestOptions {\n    return {\n      ...(newUrl == null ? this.baseRequestOptions : configureRequestOptionsFromUrl(newUrl, {})),\n      method,\n      headers: {\n        ...this.options.requestHeaders,\n        Accept: \"*/*\",\n      } as any,\n    }\n  }\n\n  protected doDownload(oldBlockMap: BlockMap, newBlockMap: BlockMap) {\n    // we don't check other metadata like compressionMethod - generic check that it is make sense to differentially update is suitable for it\n    if (oldBlockMap.version !== newBlockMap.version) {\n      throw new Error(`version is different (${oldBlockMap.version} - ${newBlockMap.version}), full download is required`)\n    }\n\n    const logger = this.logger\n    const operations = computeOperations(oldBlockMap, newBlockMap, logger)\n    if (logger.debug != null) {\n      logger.debug(JSON.stringify(operations, null, 2))\n    }\n\n    let downloadSize = 0\n    let copySize = 0\n    for (const operation of operations) {\n      const length = operation.end - operation.start\n      if (operation.kind === OperationKind.DOWNLOAD) {\n        downloadSize += length\n      }\n      else {\n        copySize += length\n      }\n    }\n\n    const newPackageSize = this.blockAwareFileInfo.size\n    if ((downloadSize + copySize + (this.fileMetadataBuffer == null ? 0 : this.fileMetadataBuffer.length) + this.signatureSize) !== newPackageSize) {\n      throw new Error(`Internal error, size mismatch: downloadSize: ${downloadSize}, copySize: ${copySize}, newPackageSize: ${newPackageSize}`)\n    }\n\n    logger.info(`Full: ${formatBytes(newPackageSize)}, To download: ${formatBytes(downloadSize)} (${Math.round(downloadSize / (newPackageSize / 100))}%)`)\n\n    return this.downloadFile(operations)\n  }\n\n  private async downloadFile(tasks: Array<Operation>): Promise<any> {\n    const signature = this.signatureSize === 0 ? null : await this.readRemoteBytes(0, this.signatureSize - 1)\n\n    const oldFileFd = await open(this.options.oldFile, \"r\")\n    const newFileFd = await open(this.options.newFile, \"w\")\n    const fileOut = createWriteStream(this.options.newFile, {fd: newFileFd})\n    await new BluebirdPromise((resolve, reject) => {\n      const streams: Array<any> = []\n      const digestTransform = new DigestTransform(this.blockAwareFileInfo.sha512)\n      // to simply debug, do manual validation to allow file to be fully written\n      digestTransform.isValidateOnEnd = false\n      streams.push(digestTransform)\n\n      // noinspection JSArrowFunctionCanBeReplacedWithShorthand\n      fileOut.on(\"finish\", () => {\n        (fileOut.close as any)(() => {\n          try {\n            digestTransform.validate()\n          }\n          catch (e) {\n            reject(e)\n            return\n          }\n\n          resolve()\n        })\n      })\n\n      streams.push(fileOut)\n\n      let lastStream = null\n      for (const stream of streams) {\n        stream.on(\"error\", reject)\n        if (lastStream == null) {\n          lastStream = stream\n        }\n        else {\n          lastStream = lastStream.pipe(stream)\n        }\n      }\n\n      const firstStream = streams[0]\n\n      let w: any\n      if (this.options.useMultipleRangeRequest) {\n        w = executeTasks(this, tasks, firstStream, oldFileFd, reject)\n      }\n      else {\n        let attemptCount = 0\n        let actualUrl: string | null = null\n        this.logger.info(`Differential download: ${this.options.newUrl}`)\n        w = (index: number) => {\n          if (index >= tasks.length) {\n            if (this.fileMetadataBuffer != null) {\n              firstStream.write(this.fileMetadataBuffer)\n            }\n            firstStream.end()\n            return\n          }\n\n          const operation = tasks[index++]\n          if (operation.kind === OperationKind.COPY) {\n            copyData(operation, firstStream, oldFileFd, reject, () => w(index))\n          }\n          else {\n            const requestOptions = this.createRequestOptions(\"get\", actualUrl)\n            const range = `bytes=${operation.start}-${operation.end - 1}`\n            requestOptions.headers!!.Range = range;\n            (requestOptions as any).redirect = \"manual\"\n\n            const debug = this.logger.debug\n            if (debug != null) {\n              debug(`effective url: ${actualUrl == null ? \"\" : removeQuery(actualUrl)}, range: ${range}`)\n            }\n\n            const request = this.httpExecutor.doRequest(requestOptions, response => {\n              // Electron net handles redirects automatically, our NodeJS test server doesn't use redirects - so, we don't check 3xx codes.\n              if (response.statusCode >= 400) {\n                reject(createHttpError(response))\n              }\n\n              response.pipe(firstStream, {\n                end: false\n              })\n              response.once(\"end\", () => {\n                if (++attemptCount === 100) {\n                  attemptCount = 0\n                  setTimeout(() => w(index), 1000)\n                }\n                else {\n                  w(index)\n                }\n              })\n            })\n            request.on(\"redirect\", (statusCode: number, method: string, redirectUrl: string) => {\n              this.logger.info(`Redirect to ${removeQuery(redirectUrl)}`)\n              actualUrl = redirectUrl\n              request.followRedirect()\n            })\n            this.httpExecutor.addErrorAndTimeoutHandlers(request, reject)\n            request.end()\n          }\n        }\n      }\n\n      if (signature == null) {\n        w(0)\n      }\n      else {\n        firstStream.write(signature, () => w(0))\n      }\n    })\n      .then(() => close(oldFileFd))\n      .catch(error => {\n        closeSync(oldFileFd)\n        closeSync(newFileFd)\n        throw error\n      })\n  }\n\n  protected async readRemoteBytes(start: number, endInclusive: number) {\n    const buffer = Buffer.allocUnsafe((endInclusive + 1) - start)\n    const requestOptions = this.createRequestOptions()\n    requestOptions.headers!!.Range = `bytes=${start}-${endInclusive}`\n    let position = 0\n    await this.request(requestOptions, chunk => {\n      chunk.copy(buffer, position)\n      position += chunk.length\n    })\n    return buffer\n  }\n\n  private request(requestOptions: RequestOptions, dataHandler: (chunk: Buffer) => void) {\n    return new BluebirdPromise((resolve, reject) => {\n      const request = this.httpExecutor.doRequest(requestOptions, response => {\n        if (!checkIsRangesSupported(response, reject)) {\n          return\n        }\n\n        response.on(\"data\", dataHandler)\n        response.on(\"end\", () => resolve())\n      })\n      this.httpExecutor.addErrorAndTimeoutHandlers(request, reject)\n      request.end()\n    })\n  }\n}\n\nexport async function readBlockMap(data: Buffer): Promise<BlockMap> {\n  return JSON.parse((await inflateRaw(data)).toString())\n}\n\nfunction formatBytes(value: number, symbol = \" KB\") {\n  return new Intl.NumberFormat(\"en\").format((value / 1024).toFixed(2) as any) + symbol\n}\n\n// safety\nfunction removeQuery(url: string) {\n  const index = url.indexOf(\"?\")\n  return index < 0 ? url : url.substring(0, index)\n}"]}
